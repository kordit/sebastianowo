<?php
class NpcPopup {

    public function __construct()
    {
        add_action('rest_api_init', [$this, 'register_endpoints']);
    }

    private function log_debug($message, $data = null)
    {
        $log_file = get_template_directory() . '/npc_debug.log';
        $timestamp = date('[Y-m-d H:i:s]');
        $log_entry = $timestamp . ' [DEBUG] ' . $message . "\n";

        if ($data !== null) {
            $log_entry .= $timestamp . ' [DATA] ' . print_r($data, true) . "\n";
        }

        error_log($log_entry, 3, $log_file);
    }

    public function register_endpoints()
    {
        // Endpoint do pokazywania początkowego popup-a NPC
        register_rest_route('game/v1', '/npc/popup', array(
            'methods' => 'POST',
            'callback' => [$this, 'get_npc_popup'],
            'permission_callback' => [$this, 'check_user_permission'],
            'args' => array(
                'npc_id' => array(
                    'required' => true,
                    'validate_callback' => function ($param) {
                        return is_numeric($param);
                    }
                ),
                'page_data' => array(
                    'required' => false,
                    'default' => array()
                ),
                'current_url' => array(
                    'required' => false,
                    'default' => ''
                )
            )
        ));

        // Endpoint do obsługi przejść między dialogami
        register_rest_route('game/v1', '/dialog', array(
            'methods' => 'POST',
            'callback' => [$this, 'handle_dialog_transition'],
            'permission_callback' => [$this, 'check_user_permission'],
            'args' => array(
                'npc_id' => array(
                    'required' => true,
                    'validate_callback' => function ($param) {
                        return is_numeric($param);
                    }
                ),
                'dialog_id' => array(
                    'required' => true
                ),
                'answer_index' => array(
                    'required' => false,
                    'validate_callback' => function ($param) {
                        return is_numeric($param);
                    }
                )
            )
        ));
    }

    /**
     * Sprawdza uprawnienia użytkownika do korzystania z endpointów
     */
    public function check_user_permission($request)
    {
        // Sprawdź czy użytkownik jest zalogowany
        if (!is_user_logged_in()) {
            $this->log_debug("BŁĄD: Użytkownik nie jest zalogowany");
            return false;
        }
        
        // Sprawdź czy user_id istnieje
        $user_id = get_current_user_id();
        if (!$user_id) {
            $this->log_debug("BŁĄD: Brak user_id");
            return false;
        }
        
        $this->log_debug("Sprawdzenie uprawnień: użytkownik {$user_id} zalogowany");
        return true;
    }

    /**
     * Bezpiecznie pobiera ID aktualnego użytkownika
     */
    private function get_secure_user_id()
    {
        $user_id = get_current_user_id();
        
        if (!$user_id) {
            throw new Exception('Użytkownik nie jest zalogowany');
        }
        
        return $user_id;
    }

    /**
     * Zwraca dane NPC i początkowy dialog dla popup-a
     * 
     * @param WP_REST_Request $request Dane żądania
     * @return WP_REST_Response Odpowiedź API
     */
   

    public function handle_dialog_transition($request)
    {
        $npc_id = $request->get_param('npc_id');
        $dialog_id = $request->get_param('dialog_id');
        $answer_index = $request->get_param('answer_index');
        $current_dialog_id = $request->get_param('current_dialog_id');
        
        try {
            // Bezpieczne pobranie user_id
            $user_id = $this->get_secure_user_id();
            
            $this->log_debug("===== PRZETWARZANIE PRZEJŚCIA DIALOGU =====");
            $this->log_debug("Parametry przejścia", [
                'npc_id' => $npc_id,
                'dialog_id' => $dialog_id,
                'answer_index' => $answer_index,
                'current_dialog_id' => $current_dialog_id,
                'user_id' => $user_id
            ]);

        try {
            // Sprawdź czy NPC istnieje
            $npc_post = get_post($npc_id);
            if (!$npc_post || $npc_post->post_type !== 'npc') {
                return new WP_REST_Response([
                    'success' => false,
                    'message' => 'NPC nie istnieje'
                ], 404);
            }

            // Pobierz dane NPC
            $npc_data = $this->get_npc_data($npc_id);

            // Pobierz dialogi NPC
            $dialogs = get_field('dialogs', $npc_id);
            if (!$dialogs || !is_array($dialogs)) {
                return new WP_REST_Response([
                    'success' => false,
                    'message' => 'Brak dialogów dla tego NPC'
                ], 404);
            }

            // Wykonaj akcje z poprzedniej odpowiedzi (jeśli wybrano odpowiedź)
            $notification = null;
            if ($current_dialog_id && is_numeric($answer_index)) {
                $this->log_debug("Wykonywanie akcji z odpowiedzi", [
                    'current_dialog_id' => $current_dialog_id,
                    'answer_index' => $answer_index
                ]);
                $notification = $this->execute_answer_actions($dialogs, $current_dialog_id, $answer_index, $user_id);
                if ($notification) {
                    $this->log_debug("Otrzymano powiadomienie z akcji: {$notification}");
                }
            }

            // Znajdź docelowy dialog
            $target_dialog = $this->find_dialog_by_id($dialogs, $dialog_id);

            if (!$target_dialog) {
                return new WP_REST_Response([
                    'success' => false,
                    'message' => 'Dialog nie został znaleziony'
                ], 404);
            }

            // Sprawdź widoczność docelowego dialogu
            if (!$this->is_dialog_visible($target_dialog, $user_id)) {
                return new WP_REST_Response([
                    'success' => false,
                    'message' => 'Dialog nie jest dostępny'
                ], 403);
            }

            // Przefiltruj odpowiedzi w dialogu
            $filtered_dialog = $this->filter_dialog_answers($target_dialog, $user_id);

            // Przygotuj dane odpowiedzi
            $response_data = [
                'success' => true,
                'dialog' => $filtered_dialog,
                'npc' => [
                    'name' => $npc_data['name'],
                    'image' => $npc_data['thumbnail_url']
                ]
            ];

            // Dodaj powiadomienie jeśli istnieje
            if ($notification) {
                $response_data['notification'] = $notification;
            }

            return new WP_REST_Response($response_data, 200);
        } catch (Exception $e) {
            error_log('NpcPopup dialog transition error: ' . $e->getMessage());
            return new WP_REST_Response([
                'success' => false,
                'message' => 'Wystąpił błąd podczas przejścia dialogu'
            ], 500);
        }
    }

    /**
     * Pobiera podstawowe dane NPC
     * 
     * @param int $npc_id ID NPC
     * @return array Dane NPC
     */
    private function get_npc_data($npc_id)
    {
        $post = get_post($npc_id);
        $thumbnail_id = get_post_thumbnail_id($npc_id);
        $thumbnail_url = $thumbnail_id ? wp_get_attachment_image_url($thumbnail_id, 'medium') : '';

        return [
            'name' => $post->post_title,
            'title' => $post->post_title,
            'thumbnail_url' => $thumbnail_url
        ];
    }

    /**
     * Znajduje pierwszy dostępny dialog dla użytkownika
     * 
     * @param array $dialogs Lista dialogów
     * @param int $user_id ID użytkownika
     * @param array $page_data Dane strony
     * @return array|null Pierwszy dostępny dialog
     */
    private function find_first_available_dialog($dialogs, $user_id, $page_data = [])
    {
        foreach ($dialogs as $dialog) {
            if ($this->is_dialog_visible($dialog, $user_id, $page_data)) {
                return $dialog;
            }
        }
        return null;
    }

    /**
     * Znajduje dialog po ID
     * 
     * @param array $dialogs Lista dialogów
     * @param string $dialog_id ID dialogu
     * @return array|null Znaleziony dialog
     */
    private function find_dialog_by_id($dialogs, $dialog_id)
    {
        foreach ($dialogs as $dialog) {
            if (isset($dialog['id_pola']) && $dialog['id_pola'] === $dialog_id) {
                return $dialog;
            }
        }
        return null;
    }

    /**
     * Sprawdza czy dialog jest widoczny dla użytkownika
     * 
     * @param array $dialog Dane dialogu
     * @param int $user_id ID użytkownika
     * @param array $page_data Dane strony
     * @return bool True jeśli dialog jest widoczny
     */
    private function is_dialog_visible($dialog, $user_id, $page_data = [])
    {
        $dialog_id = $dialog['id_pola'] ?? 'unknown';
        $this->log_debug("Sprawdzanie widoczności dialogu: {$dialog_id}");

        // Sprawdź ustawienia widoczności
        if (!isset($dialog['dialog_settings']) || !is_array($dialog['dialog_settings'])) {
            $this->log_debug("Dialog {$dialog_id}: Brak ustawień widoczności - domyślnie widoczny");
            return true; // Domyślnie widoczny jeśli brak ustawień
        }

        $visibility_settings = $dialog['dialog_settings']['visibility_settings'] ?? [];
        $logic_operator = $dialog['dialog_settings']['logic_operator'] ?? 'and';

        $this->log_debug("Dialog {$dialog_id}: Ustawienia widoczności", [
            'logic_operator' => $logic_operator,
            'conditions_count' => count($visibility_settings)
        ]);

        if (empty($visibility_settings)) {
            $this->log_debug("Dialog {$dialog_id}: Brak warunków - domyślnie widoczny");
            return true; // Brak warunków = widoczny
        }

        $results = [];
        foreach ($visibility_settings as $index => $condition) {
            $result = $this->evaluate_visibility_condition($condition, $user_id, $page_data);
            $results[] = $result;
            $this->log_debug("Dialog {$dialog_id}: Warunek #{$index} - wynik: " . ($result ? 'SPEŁNIONY' : 'NIE SPEŁNIONY'), $condition);
        }

        // Zastosuj operator logiczny
        $final_result = false;
        if ($logic_operator === 'or') {
            $final_result = in_array(true, $results);
        } else {
            $final_result = !in_array(false, $results);
        }

        $this->log_debug("Dialog {$dialog_id}: Końcowy wynik widoczności: " . ($final_result ? 'WIDOCZNY' : 'UKRYTY'));
        return $final_result;
    }
    /**
     * Ocenia pojedynczy warunek widoczności
     * 
     * @param array $condition Warunek widoczności
     * @param int $user_id ID użytkownika
     * @param array $page_data Dane strony
     * @return bool Wynik oceny warunku
     */
    private function evaluate_visibility_condition($condition, $user_id, $page_data = [])
    {
        $type = $condition['acf_fc_layout'] ?? '';
        $this->log_debug("Ocena warunku typu: {$type}", $condition);

        $result = false;
        switch ($type) {
            case 'stat':
                $result = $this->check_stat_condition($condition, $user_id);
                break;

            case 'skill':
                $result = $this->check_skill_condition($condition, $user_id);
                break;

            case 'item':
                $result = $this->check_item_condition($condition, $user_id);
                break;

            case 'relation':
                $result = $this->check_relation_condition($condition, $user_id);
                break;

            case 'mission':
                $result = $this->check_mission_condition($condition, $user_id);
                break;

            case 'user_class':
                $result = $this->check_user_class_condition($condition, $user_id);
                break;

            default:
                $this->log_debug("NIEROZPOZNANY typ warunku: {$type}");
                $result = true; // Nieznane warunki są domyślnie spełnione
        }

        $this->log_debug("Wynik warunku {$type}: " . ($result ? 'SPEŁNIONY' : 'NIE SPEŁNIONY'));
        return $result;
    }
    /**
     * Sprawdza warunek statystyki
     */
    private function check_stat_condition($condition, $user_id)
    {
        $stat_name = $condition['stat'] ?? '';
        $operator = $condition['operator'] ?? '>=';
        $value = intval($condition['value'] ?? 0);

        $user_stats = get_field('stats', 'user_' . $user_id) ?: [];
        $current_value = intval($user_stats[$stat_name] ?? 0);

        $result = $this->compare_values($current_value, $operator, $value);

        $this->log_debug("Warunek statystyki", [
            'stat_name' => $stat_name,
            'operator' => $operator,
            'required_value' => $value,
            'current_value' => $current_value,
            'result' => $result
        ]);

        return $result;
    }
    /**
     * Sprawdza warunek umiejętności
     */
    private function check_skill_condition($condition, $user_id)
    {
        $skill_name = $condition['skill'] ?? '';
        $operator = $condition['operator'] ?? '>=';
        $value = intval($condition['value'] ?? 0);

        $user_skills = get_field('skills', 'user_' . $user_id) ?: [];
        $current_value = intval($user_skills[$skill_name] ?? 0);

        $result = $this->compare_values($current_value, $operator, $value);

        $this->log_debug("Warunek umiejętności", [
            'skill_name' => $skill_name,
            'operator' => $operator,
            'required_value' => $value,
            'current_value' => $current_value,
            'result' => $result
        ]);

        return $result;
    }

    /**
     * Sprawdza warunek przedmiotu
     */
    private function check_item_condition($condition, $user_id)
    {
        $item_id = intval($condition['item'] ?? 0);
        $operator = $condition['operator'] ?? '>=';
        $required_quantity = intval($condition['quantity'] ?? 1);

        $user_items = get_field('items', 'user_' . $user_id) ?: [];
        $current_quantity = 0;

        foreach ($user_items as $user_item) {
            if (intval($user_item['item']) === $item_id) {
                $current_quantity = intval($user_item['quantity'] ?? 0);
                break;
            }
        }

        return $this->compare_values($current_quantity, $operator, $required_quantity);
    }

    /**
     * Sprawdza warunek relacji z NPC
     */
    private function check_relation_condition($condition, $user_id)
    {
        $npc_id = intval($condition['npc'] ?? 0);
        $operator = $condition['operator'] ?? '>=';
        $value = intval($condition['value'] ?? 0);

        $user_relations = get_field('relation_npc', 'user_' . $user_id) ?: [];
        $current_value = 0;

        foreach ($user_relations as $relation) {
            if (intval($relation['npc']) === $npc_id) {
                $current_value = intval($relation['relation'] ?? 0);
                break;
            }
        }

        return $this->compare_values($current_value, $operator, $value);
    }

    /**
     * Sprawdza warunek misji
     */
    private function check_mission_condition($condition, $user_id)
    {
        $mission_id = intval($condition['mission'] ?? 0);
        $status = $condition['status'] ?? 'completed';

        $user_missions = get_field('user_missions', 'user_' . $user_id) ?: [];

        foreach ($user_missions as $mission) {
            if (intval($mission['mission']) === $mission_id) {
                return $mission['status'] === $status;
            }
        }

        return false;
    }

    /**
     * Sprawdza warunek klasy użytkownika
     */
    private function check_user_class_condition($condition, $user_id)
    {
        $required_class = $condition['class'] ?? '';
        $user_class_data = get_field('user_class', 'user_' . $user_id);
        $user_class = is_array($user_class_data) ? ($user_class_data['value'] ?? '') : $user_class_data;

        return $user_class === $required_class;
    }

    /**
     * Porównuje wartości według operatora
     */
    private function compare_values($current, $operator, $required)
    {
        switch ($operator) {
            case '>=':
                return $current >= $required;
            case '>':
                return $current > $required;
            case '<=':
                return $current <= $required;
            case '<':
                return $current < $required;
            case '==':
                return $current == $required;
            case '!=':
                return $current != $required;
            default:
                return $current >= $required;
        }
    }

    /**
     * Filtruje odpowiedzi w dialogu na podstawie warunków widoczności
     * 
     * @param array $dialog Dane dialogu
     * @param int $user_id ID użytkownika
     * @param array $page_data Dane strony
     * @return array Przefiltrowany dialog
     */
    private function filter_dialog_answers($dialog, $user_id, $page_data = [])
    {
        if (!isset($dialog['anwsers']) || !is_array($dialog['anwsers'])) {
            return $dialog;
        }

        $filtered_answers = [];
        foreach ($dialog['anwsers'] as $answer) {
            if ($this->is_answer_visible($answer, $user_id, $page_data)) {
                $filtered_answers[] = $answer;
            }
        }

        $dialog['anwsers'] = $filtered_answers;
        return $dialog;
    }

    /**
     * Sprawdza czy odpowiedź jest widoczna dla użytkownika
     */
    private function is_answer_visible($answer, $user_id, $page_data = [])
    {
        if (!isset($answer['layout_settings']) || !is_array($answer['layout_settings'])) {
            return true;
        }

        $visibility_settings = $answer['layout_settings']['visibility_settings'] ?? [];
        $logic_operator = $answer['layout_settings']['logic_operator'] ?? 'and';

        if (empty($visibility_settings)) {
            return true;
        }

        $results = [];
        foreach ($visibility_settings as $condition) {
            $results[] = $this->evaluate_visibility_condition($condition, $user_id, $page_data);
        }

        if ($logic_operator === 'or') {
            return in_array(true, $results);
        } else {
            return !in_array(false, $results);
        }
    }

    /**
     * Wykonuje akcje związane z wybraną odpowiedzią
     * 
     * @param array $dialogs Lista wszystkich dialogów
     * @param string $dialog_id ID aktualnego dialogu
     * @param int $answer_index Indeks wybranej odpowiedzi
     * @param int $user_id ID użytkownika
     * @return string|null Powiadomienie o wykonanych akcjach
     */
    private function execute_answer_actions($dialogs, $dialog_id, $answer_index, $user_id)
    {
        $dialog = $this->find_dialog_by_id($dialogs, $dialog_id);
        if (!$dialog || !isset($dialog['anwsers'][$answer_index])) {
            return null;
        }

        $answer = $dialog['anwsers'][$answer_index];
        $actions = $answer['type_anwser'] ?? [];

        $notifications = [];
        $manager_user = new ManagerUser($user_id);

        foreach ($actions as $action) {
            $action_type = $action['acf_fc_layout'] ?? '';

            switch ($action_type) {
                case 'transaction':
                    $result = $this->execute_transaction_action($action, $manager_user);
                    if ($result) $notifications[] = $result;
                    break;

                case 'item':
                    $result = $this->execute_item_action($action, $user_id);
                    if ($result) $notifications[] = $result;
                    break;

                case 'exp_rep':
                    $result = $this->execute_exp_rep_action($action, $manager_user);
                    if ($result) $notifications[] = $result;
                    break;

                case 'relation':
                    $result = $this->execute_relation_action($action, $user_id);
                    if ($result) $notifications[] = $result;
                    break;

                case 'function':
                    $result = $this->execute_function_action($action, $user_id);
                    if ($result) $notifications[] = $result;
                    break;

                case 'skills':
                    $result = $this->execute_skills_action($action, $manager_user);
                    if ($result) $notifications[] = $result;
                    break;

                case 'mission':
                    $result = $this->execute_mission_action($action, $user_id);
                    if ($result) $notifications[] = $result;
                    break;
            }
        }

        return !empty($notifications) ? implode(', ', $notifications) : null;
    }

    /**
     * Wykonuje akcję transakcji
     */
    private function execute_transaction_action($action, $manager_user)
    {
        $currency = $action['backpack'] ?? 'gold';
        $value = intval($action['value'] ?? 0);

        $field_name = 'backpack_' . $currency;
        $result = $manager_user->updateNumericField($field_name, $value);

        return $result['success'] ? $result['message'] : null;
    }

    /**
     * Wykonuje akcję przedmiotu
     */
    private function execute_item_action($action, $user_id)
    {
        $item_id = intval($action['item'] ?? 0);
        $quantity = intval($action['quantity'] ?? 1);

        if ($item_id <= 0) return null;

        $user_items = get_field('items', 'user_' . $user_id) ?: [];
        $item_found = false;

        // Sprawdź czy użytkownik już ma ten przedmiot
        foreach ($user_items as &$user_item) {
            if (intval($user_item['item']) === $item_id) {
                $user_item['quantity'] = intval($user_item['quantity']) + $quantity;
                $item_found = true;
                break;
            }
        }

        // Jeśli nie ma przedmiotu, dodaj nowy
        if (!$item_found) {
            $user_items[] = [
                'item' => $item_id,
                'quantity' => $quantity
            ];
        }

        update_field('items', $user_items, 'user_' . $user_id);

        $item_name = get_the_title($item_id);
        return ($quantity > 0 ? 'Otrzymano' : 'Utracono') . " {$quantity}x {$item_name}";
    }

    /**
     * Wykonuje akcję doświadczenia/reputacji
     */
    private function execute_exp_rep_action($action, $manager_user)
    {
        $type = $action['type'] ?? 'exp';
        $value = intval($action['value'] ?? 0);

        $field_name = 'progress_' . $type;
        $result = $manager_user->updateNumericField($field_name, $value);

        return $result['success'] ? $result['message'] : null;
    }

    /**
     * Wykonuje akcję relacji z NPC
     */
    private function execute_relation_action($action, $user_id)
    {
        $npc_id = intval($action['npc'] ?? 0);
        $change = intval($action['change_relation'] ?? 0);
        $poznaj = intval($action['poznaj'] ?? 0);

        if ($npc_id <= 0) return null;

        $user_relations = get_field('relation_npc', 'user_' . $user_id) ?: [];
        $relation_found = false;

        foreach ($user_relations as &$relation) {
            if (intval($relation['npc']) === $npc_id) {
                $relation['relation'] = intval($relation['relation']) + $change;
                if ($poznaj) $relation['poznaj'] = 1;
                $relation_found = true;
                break;
            }
        }

        if (!$relation_found) {
            $user_relations[] = [
                'npc' => $npc_id,
                'relation' => $change,
                'poznaj' => $poznaj
            ];
        }

        update_field('relation_npc', $user_relations, 'user_' . $user_id);

        $npc_name = get_the_title($npc_id);
        if ($poznaj) {
            return "Poznano postać: {$npc_name}";
        }
        return ($change > 0 ? 'Poprawiono' : 'Pogorszono') . " relację z {$npc_name}";
    }

    /**
     * Wykonuje akcję funkcji (np. SetClass)
     */
    private function execute_function_action($action, $user_id)
    {
        $function = $action['do_function'] ?? '';

        switch ($function) {
            case 'SetClass':
                $class = $action['user_class'] ?? '';
                if ($class) {
                    update_field('user_class', ['value' => $class], 'user_' . $user_id);
                    return "Ustawiono klasę: {$class}";
                }
                break;

                // Dodaj inne funkcje w przyszłości
        }

        return null;
    }

    /**
     * Wykonuje akcję umiejętności
     */
    private function execute_skills_action($action, $manager_user)
    {
        $skill = $action['skill'] ?? '';
        $value = intval($action['value'] ?? 0);

        if (!$skill) return null;

        $field_name = 'skills_' . $skill;
        $result = $manager_user->updateNumericField($field_name, $value);

        return $result['success'] ? $result['message'] : null;
    }

    /**
     * Wykonuje akcję misji
     */
    private function execute_mission_action($action, $user_id)
    {
        $mission_id = intval($action['mission'] ?? 0);
        $status = $action['status'] ?? 'active';

        if ($mission_id <= 0) return null;

        $user_missions = get_field('user_missions', 'user_' . $user_id) ?: [];
        $mission_found = false;

        foreach ($user_missions as &$mission) {
            if (intval($mission['mission']) === $mission_id) {
                $mission['status'] = $status;
                $mission_found = true;
                break;
            }
        }

        if (!$mission_found) {
            $user_missions[] = [
                'mission' => $mission_id,
                'status' => $status
            ];
        }

        update_field('user_missions', $user_missions, 'user_' . $user_id);

        $mission_name = get_the_title($mission_id);
        return "Misja '{$mission_name}' - status: {$status}";
    }

    /**
     * Sprawdza uprawnienia użytkownika do korzystania z endpointów
     */
    public function check_user_permission($request)
    {
        // Sprawdź czy użytkownik jest zalogowany
        if (!is_user_logged_in()) {
            $this->log_debug("BŁĄD: Użytkownik nie jest zalogowany");
            return false;
        }
        
        // Sprawdź czy user_id istnieje
        $user_id = get_current_user_id();
        if (!$user_id) {
            $this->log_debug("BŁĄD: Brak user_id");
            return false;
        }
        
        $this->log_debug("Sprawdzenie uprawnień: użytkownik {$user_id} zalogowany");
        return true;
    }

    /**
     * Bezpiecznie pobiera ID aktualnego użytkownika
     */
    private function get_secure_user_id()
    {
        $user_id = get_current_user_id();
        
        if (!$user_id) {
            throw new Exception('Użytkownik nie jest zalogowany');
        }
        
        return $user_id;
    }
}

// Inicjalizuj klasę
new NpcPopup();
